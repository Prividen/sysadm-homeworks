# Домашняя работа по занятию "3.7. Компьютерные сети, лекция 2"

> 1. Например, если вы захотите передать 500 Гб бэкап... Подсчитайте, какого размера нужно окно TCP чтобы наполнить 1 Гбит/с канал при 300 мс RTT (берем простую ситуацию без потери пакетов). 
   
1Гбит/с канал - это же наша сетевая карта? Тогда, у нас там будет некоторый оверхед. Предположим, что у нас MTU=1500 и мы не используем VLANы. Тогда, размер MSS (который мы будем учитывать в формуле из вики) будет 1500 - 20(IP) - 20(TCP) = 1460. А в гигабит нашего линка мы будем пытаться пропихнуть 1500 + 18(eth l2) + 20(eth l1) = 1538. 

Т.е. %% полезной нагрузки (mss) внутри ethernet-l1 фрейма составит: 1460 * 100 / 1538 = 94.92848%. Таким образом, внутри физического гигабита у нас будет 1024 * 94.92848% = 972.0676 Mbit/s отборнейшего TCP.  

Подставим в формулу из вики: 972.0676 * 0.3 = 291.62028mbit, или 291.62028 / 8 * 1024 = 37327.39584 kb. А так как максимальный размер tcp windows - 64кб, нам нужно использовать окно 64K и scale factor 584.

А наш бакапный файл, 500Гб, он же 4096000 Mbit. Со скоростью 972.0676 Mbit/s он будет передаваться 4213.7 секунды, или где-то час и 10 минут. Ну, терпимо.

---
> 2. Во сколько раз упадет пропускная способность канала, если будет 1% потерь пакетов при передаче?

Калькуляторы и формулы уверяют, что при MSS=1460 и RTT=300 ничего лучше 0.38933 mbit/s нас не ждёт. Т.е. падение скорости в 2496,75 раз. Ужас.

---
> 3. Какая  максимальная реальная скорость передачи данных достижима при линке 100 Мбит/с? Вопрос про TCP payload, то есть цифры, которые вы реально увидите в операционной системе в тестах или в браузере при скачивании файлов. 

Кажется, я уже посчитал процент оверхеада. Если применить к 100Mbit/s то получим 94.92848 Mbit. 

> Повлияет ли размер фрейма на это?

Да, разумеется! Меньше пакетов для одного и того же количества данных, меньше оверхеада. Посчитаем для MTU=9000: 

MSS = 9000 - 40 = 8960; eth l1 = 9000 + 38 = 9038, %пейлоада будет = 8960 * 100 / 9038 = 99,137%.

Т.е. внутри 100Mbit линка будет 99.137 Mbit tcp-данных. 

---
> 4. Что на самом деле происходит, когда вы открываете сайт? :)

<img src="https://media.tenor.com/images/1fb93e098589d31f5023b7d32418f013/tenor.gif" alt="Magic!"/>

> Опишите максимально подробно насколько вы это можете сделать, что происходит, когда вы делаете запрос `curl -I http://netology.ru` с вашей рабочей станции. Предположим, что arp кеш очищен, в локальном DNS нет закешированных записей.

Оболочка запускает curl, он инициализируется, читает все свои библиотеки и конфиги. Из /etc/nsswitch.conf он узнаёт, как на этой системе правильно резолвить имена. В /etc/resolv.conf он узнаёт как резовлить имена через DNS. В /etc/hosts ничего про netology.ru не находит, поэтому пытается сделать запрос к DNS серверу:
```
 [pid  1501] connect(3, {sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr("98.158.110.2")}, 16 <unfinished ...>
...
 [pid  1501] <... sendmmsg resumed>[{msg_hdr={msg_name=NULL, msg_namelen=0, 
 msg_iov=[{iov_base="\233\350\1\0\0\1\0\0\0\0\0\0\10netology\2ru\0\0\1\0\1", iov_len=29}],
 msg_iovlen=1, msg_controllen=0, msg_flags=0}, msg_len=29}, {msg_hdr={msg_name=NULL,
 msg_namelen=0, msg_iov=[{iov_base="\227C\1\0\0\1\0\0\0\0\0\0\10netology\2ru\0\0\34\0\1",
 iov_len=29}], msg_iovlen=1, msg_controllen=0, msg_flags=0}, msg_len=29}], 2, MSG_NOSIGNAL) = 2
```
Система пытается понять, как ей добраться до NS-сервера. Она смотрит, выполняется ли равенство (my_IP & my_mask == DNS_IP & my_mask), убеждается, что нет, и понимает, что подключение к DNS серверу нужно делать через шлюз по умолчанию.   

Шлюза по умолчанию по условиям задачи в ARP-таблице нет, поэтому первым делом будет выполнет ARP-запрос, чтобы найти его MAC:
```
14:32:54.567033 00:50:56:b9:a5:c4 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Request who-has 10.1.4.1 tell 10.1.4.25, length 28
14:32:54.567830 00:50:56:b9:26:86 > 00:50:56:b9:a5:c4, ethertype ARP (0x0806), length 60: Reply 10.1.4.1 is-at 00:50:56:b9:26:86, length 46
```
Далее, система посылает DNS-запросы на резолвинг записей A и AAAA на IP DNS-сервера, используя DST MAC шлюза по умолчанию:
```
14:32:54.567841 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 71: 10.1.4.25.36034 > 98.158.110.2.53: 39912+ A? netology.ru. (29)
14:32:54.567855 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 71: 10.1.4.25.36034 > 98.158.110.2.53: 38723+ AAAA? netology.ru. (29)
```
Мой шлюз (gw1) тоже складывает IP адреса и маски, убеждается, что DNS не в его сети, и нужно маршрутизировать пакет. В рамках NAT делает подмену SRC-IP на свой собственный, и отправляет запрос дальше, на свой шлюз по умолчанию (gw2). (src-ip: gw1, dst-ip: dns, src-mac: gw1, dst-mac: gw2)
Следующий хоп, gw2 - магистральная циска, шлюза по умолчанию у неё нет. Она принимает решение о дальнейшей маршрутизации к anycast-адресу DNS сервера, руководствуясь своей магией BGP и fullview, пакет проходит ещё через пару хопов и попадает к DNS-серверу.

На этом DNS-сервере разрешена рекурсия для наших сетей, и он выполняет всю дальнейшую работу по распознаванию имени:
- спрашивает корневые сервера про зону .ru
- спрашивает сервера зоны .ru про зону netology.ru
- спрашивает сервера зоны netology.ru про A (AAAA) запись netology.ru.

Пакет с распознанными IP хоста netology.ru возвращается по цепочке маршрутизаторов назад на gw1, по таблице NAT восстанавливается мой оригинальный адрес отправителя, пакет доходит до моей системы
```
14:32:54.569247 00:1b:0d:e5:f8:80 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 155: 98.158.110.2.53 > 10.1.4.25.36034: 38723 3/0/0 AAAA 2606:4700:10::6816:31ab, AAAA 2606:4700:10::ac43:2b53, AAAA 2606:4700:10::6816:30ab (113)
14:32:54.569431 00:1b:0d:e5:f8:80 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 119: 98.158.110.2.53 > 10.1.4.25.36034: 39912 3/0/0 A 172.67.43.83, A 104.22.49.171, A 104.22.48.171 (77)
```
Далее, curl решает открыть HTTP-подключение на IPv6 адрес netology.ru, но обламывается, потому что у меня на тестовом хосте из IPv6 сконфигурирован только немаршрутизируемый link-адрес:
```
[pid  1501] connect(3, {sa_family=AF_INET6, sin6_port=htons(80), sin6_flowinfo=htonl(0), inet_pton(AF_INET6, "2606:4700:10::6816:31ab", &sin6_addr), sin6_scope_id=0}, 28U <unfinished ...>
[pid  1500] <... write resumed>)        = 1
[pid  1501] <... connect resumed>)      = -1 ENETUNREACH (Network is unreachable)
```

Тогда будем использовать IPv4, и попытаемся открыть TCP-соединение на отрезолвенный IP адрес netology.ru на 80 порт:
```
[pid  1501] connect(3, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("172.67.43.83")}, 16  <unfinished ...>
```

Система складывает маски-ip, убеждается, что ip `172.67.43.83` не в нашей сети и надо пользоваться шлюзом, и шлёт через него TCP-syn пакет. Тут опять магия nat-шлюзы-bgp. Нам в ответ приходит TCP-пакет с SYN,ACK, мы на него отвечаем TCP-пакетом с ACK. Соединение установлено.
```
14:32:54.588057 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 74: 10.1.4.25.38616 > 172.67.43.83.80: Flags [S], seq 4095442247, win 29200, options [mss 1460,sackOK,TS val 2600739565 ecr 0,nop,wscale 7], length 0
14:32:54.589266 00:50:56:b9:26:86 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 66: 172.67.43.83.80 > 10.1.4.25.38616: Flags [S.], seq 1864043773, ack 4095442248, win 65535, options [mss 1400,nop,nop,sackOK,nop,wscale 10], length 0
14:32:54.589303 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 54: 10.1.4.25.38616 > 172.67.43.83.80: Flags [.], ack 1, win 229, length 0
```

Далее, мы общаемся с веб-сервером уже по HTTP. Опция -I у `curl` просит запросить с веб-сервера только HTTP-заголовки, что curl и делает (по HTTP/1.1, посылая дополнительную информацию по желаемому хостнейму, user-agent и прочие клиентские параметры запроса):
```
sendto(3, "HEAD / HTTP/1.1\r\nHost: netology."..., 76, MSG_NOSIGNAL, NULL, 0) = 76

14:32:54.590707 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 130: 10.1.4.25.38616 > 172.67.43.83.80: Flags [P.], seq 1:77, ack 1, win 229, length 76
	0x0000:  4500 0074 efd9 4000 4006 64fa 0a01 0419  E..t..@.@.d.....
	0x0010:  ac43 2b53 96d8 0050 f41b 7d48 6f1b 0cfe  .C+S...P..}Ho...
	0x0020:  5018 00e5 e616 0000 4845 4144 202f 2048  P.......HEAD./.H
	0x0030:  5454 502f 312e 310d 0a48 6f73 743a 206e  TTP/1.1..Host:.n
	0x0040:  6574 6f6c 6f67 792e 7275 0d0a 5573 6572  etology.ru..User
	0x0050:  2d41 6765 6e74 3a20 6375 726c 2f37 2e36  -Agent:.curl/7.6
	0x0060:  312e 310d 0a41 6363 6570 743a 202a 2f2a  1.1..Accept:.*/*
	0x0070:  0d0a 0d0a                                ....
```
Web-сервер подтверждает получение пакета TCP-ACKом, и, согласно своей логике работы, шлёт некий HTTP-ответ, получение которого мы тоже подтверждаем ACK:
```
14:32:54.591546 00:50:56:b9:26:86 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 60: 172.67.43.83.80 > 10.1.4.25.38616: Flags [.], ack 77, win 64, length 0
14:32:54.602570 00:50:56:b9:26:86 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 430: 172.67.43.83.80 > 10.1.4.25.38616: Flags [P.], seq 1:377, ack 77, win 64, length 376
E...\o@.;..8.C+S
....P..o.....}.P..@....HTTP/1.1 301 Moved Permanently
Date: Thu, 22 Apr 2021 12:32:54 GMT
Connection: keep-alive
Cache-Control: max-age=3600
Expires: Thu, 22 Apr 2021 13:32:54 GMT
Location: https://netology.ru/
cf-request-id: 099b2abb3f0000c769c1ab7000000001
Server: cloudflare
CF-RAY: 643ee0a53fb7c769-AMS
alt-svc: h3-27=":443"; ma=86400, h3-28=":443"; ma=86400, h3-29=":443"; ma=86400

14:32:54.602593 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 54: 10.1.4.25.38616 > 172.67.43.83.80: Flags [.], ack 377, win 237, length 0

recvfrom(3, "HTTP/1.1 301 Moved Permanently\r\n"..., 102400, 0, NULL, NULL) = 376
```

Нам прислали HTTP-код `403 Moved Permanently` и новый ЮРЛ для дальшейшего подключения (`Location: https://netology.ru/`). Далее, по хорошему, нам бы открыть новое TCP-соединение на :443 порт, запросить сертификат, проверить его, сделать новый HTTP-запрос... Но у нас был флаг -I, поэтому мы выводим на экран информацию о полученных HTTP-заголовках и закрываем соединение. `curl` закрывает свой файловый дескриптор, а система закрывает TCP-соединение, обмениваясь финальными пакетами с FIN и ACK-флагами. Мы, как инициаторы закрытия, шлём FIN и ACK, сервер нам отвечает теми же FIN и ACK, и мы финально подтверждаем закрытие последним ACK.

```
write(1, "HTTP/1.1 301 Moved Permanently\r\n"..., 376HTTP/1.1 301 Moved Permanently^M
Date: Thu, 22 Apr 2021 12:32:54 GMT^M
Connection: keep-alive^M
Cache-Control: max-age=3600^M
Expires: Thu, 22 Apr 2021 13:32:54 GMT^M
Location: https://netology.ru/^M
cf-request-id: 099b2abb3f0000c769c1ab7000000001^M
Server: cloudflare^M
CF-RAY: 643ee0a53fb7c769-AMS^M
alt-svc: h3-27=":443"; ma=86400, h3-28=":443"; ma=86400, h3-29=":443"; ma=86400^M
^M
) = 376

close(3)

14:32:54.616037 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 54: 10.1.4.25.38616 > 172.67.43.83.80: Flags [F.], seq 77, ack 377, win 237, length 0
14:32:54.617121 00:50:56:b9:26:86 > 00:50:56:b9:a5:c4, ethertype IPv4 (0x0800), length 60: 172.67.43.83.80 > 10.1.4.25.38616: Flags [F.], seq 377, ack 78, win 64, length 0
14:32:54.617144 00:50:56:b9:a5:c4 > 00:50:56:b9:26:86, ethertype IPv4 (0x0800), length 54: 10.1.4.25.38616 > 172.67.43.83.80: Flags [.], ack 378, win 237, length 0
```

---
> 5. Сколько и каких итеративных запросов будет сделано при резолве домена `www.google.co.uk`?

1. Спрашиваем у корневого сервера
```
$ dig A www.google.co.uk. @a.root-servers.net. +noall +authority +answer
...
uk.			172800	IN	NS	dns1.nic.uk.
uk.			172800	IN	NS	dns4.nic.uk.
...
```
2. Спрашиваем у дежурного по .uk:
```
$ dig A www.google.co.uk. @dns1.nic.uk. +noall +authority +answer
google.co.uk.		172800	IN	NS	ns1.google.com.
google.co.uk.		172800	IN	NS	ns2.google.com.
```
Сразу о гугле знает!

3. Спрашиваем у гугля:
```
$ dig A www.google.co.uk. @ns1.google.com. +noall +authority +answer
www.google.co.uk.	300	IN	A	172.217.168.35
```
Ура, нашли за три вопроса.

---
> 6. Сколько доступно для назначения хостам адресов в подсети `/25`? 

128-2=126. 

> А в подсети с маской `255.248.0.0`. Постарайтесь потренироваться в ручных вычислениях чтобы немного набить руку, не пользоваться калькулятором сразу.

524286! пришлось на салфеточке в столбик помножать.

---
> 7. В какой подсети больше адресов, в `/23` или `/24`?

в `/23` адресов больше в два раза, чем в `/24`, 512(510)

---
> 8. Получится ли разделить диапазон `10.0.0.0/8` на 128 подсетей по 131070 адресов в каждой? Какая маска будет у таких подсетей?

128 - это на бит меньше чем 256, полный байт... т.е. 255.254.0.0.. А сколько там адресов? в 255.255.0.0 было бы 65536, а тут в два раза больше... чорт, опять салфеточка. 131072, да, сходится.
   
Да, `10.0.0.0/8` можно разделить на 128 подсетей по 131070 хостов каждая с маской /15 (255.254.0.0)
