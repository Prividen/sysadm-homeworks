# Домашняя работа по занятию "3.6. Компьютерные сети, лекция 1"

> 1. Необязательное задание: можно посмотреть целый фильм в консоли `telnet towel.blinkenlights.nl` :)

Вспомнил дозвонку на BBS, поностальгировал!

---
> 2. Узнайте о том, сколько действительно независимых (не пересекающихся) каналов есть в разделяемой среде WiFi при работе на 2.4 ГГц. 

Если рассматрировать стандартные 20MHz каналы, то, как бы три - 1, 6, 11. На самом деле, говорят, они всё равно немного пересекаются из-за вылезания части радиосигнала за пределы ширины канала.

А ещё можно, выбрав Японию, если прошивка позволяет, попробовать нелегально поиспользовать 14 канал, который вроде тоже независимый, хотя и прилегает вплотную к 11-му.

> Стандарты с полосой 5 ГГц более актуальны, но регламенты на 5 ГГц существенно различаются в разных странах, а так же не раз обновлялись. В качестве дополнительного вопроса вне зачета, попробуйте найти актуальный ответ и на этот вопрос.

Там попытались все канали сделать непересекающимися. Если рассматривать стандартные 20MHz каналы, то технически-международно у нас есть полосы UNII-1, UNII-2, UNII-3 (в каждом по 4 канала) и ещё ISM с одним каналом. И ещё UNII-2 Extended с 12 каналами. То есть, в сумме вроде как 25 каналов. 

Но потом начинаются нюансы. Не все упомянутые полосы были отданы под WiFi единовременно, изначально были доступны UNII-1, UNII-3 и ISM, так что старые устройства-прошивки могут работать с ограниченным числом каналов.

Внутри UNII-2 и UNII-2 ext могут работать всякие авиарадары, поэтому вещать в них приходится, внимательно прислушиваясь к эфиру и, чуть что, меняя канал на свободный (Dynamic Frequency Selection). 

В России из UNII-2 ext разрешается использовать только 4 канала, поэтому всего их доступно 17, а не 25. 

А ещё можно использовать более широкие каналы, тогда у нас будет доступно 12 40MHz каналов. Или 6 80MHz. Или 2 по 160MHz. Сложна...    

---
> 3. Адрес канального уровня – MAC адрес – это 6 байт, первые 3 из которых называются OUI – Organizationally Unique Identifier или уникальный идентификатор организации. Какому производителю принадлежит MAC `38:f9:d3:55:55:79`?

Apple, Inc.

---
> 4. Каким будет payload TCP сегмента, если Ethernet MTU задан в 9001 байт, размер заголовков IPv4 – 20 байт, а TCP – 32 байта?

MTU - это размер полезных данных Ethernet-фрейма, т.е. eth-заголовки-трейлеры туда не входят. Тогда, 9001 - 20 - 32 = 8949.

---
> 5. Может ли во флагах TCP одновременно быть установлены флаги SYN и FIN при штатном режиме работы сети? Почему да или нет?

При штатном режиме работы не может - флаг SYN используется для установки TCP-сессии, а FIN для её завершения, и в TCP нет сценария, когда нужны оба флага одновременно. Если поймали такой пакет, то он может быть признаком атаки или кривого железа, и ответ на него может быть только один - RST! Ну или проигнорировать и дропнуть.

---
> 6. `ss -ula sport = :53` на хосте имеет следующий вывод:...<br>
Почему в `State` присутствует только `UNCONN`, и может ли там присутствовать, например, `TIME-WAIT`?
   
Параметр `-u` просит `ss` показывать только UDP-сокеты, `ss` их показывает только в двух состояниях - `UNCONN` или `ESTAB` (если программа для работы с UDP-сокетом использует системный вызов `connect`).

`TIME-WAIT` - это возможное состояние TCP-сокета, и в данном выводе такое присутствовать не будет. 

---
> 7. Обладая знаниями о том, как штатным образом завершается соединение (FIN от инициатора, FIN-ACK от ответчика, ACK от инициатора), опишите в каких состояниях будет находиться TCP соединение в каждый момент времени на клиенте и на сервере при завершении. Схема переходов состояния соединения вам в этом поможет.

|Инициатор закрытия (Active) | Передаваемый флаг | Получатель закрытия (Passive)
|-------------------------|----------------------|-------------------------
|ESTAB| |ESTAB
|FIN_WAIT_1| -- FIN --> |
| | <-- ACK -- | CLOSE_WAIT
|FIN_WAIT_2| |
| | <-- FIN -- |
|TIME_WAIT | -- ACK --> |
| ... 4 min | | CLOSED
|CLOSED | |

---
> 8. TCP порт – 16 битное число. Предположим, 2 находящихся в одной сети хоста устанавливают между собой соединения. 
> Каким будет теоретическое максимальное число соединений, ограниченное только лишь параметрами L4, которое параллельно может установить клиент с одного IP адреса к серверу с одним IP адресом? 

Клиент для установки каждого соединения будет использовать по одному исходящему порту, так что получается, с одного клиента мы могли бы установить 65536 соединений. 
Ну, реально поменьше - системные порты вряд ли будут использоваться. Не уверен, что исходящий порт можно как-то шарить для нескольких соединений.

> Сколько соединений сможет обслужить сервер от одного клиента? А если клиентов больше одного?

Тут немного непонятно, слушает ли сервер только один какой-то порт, типа :80, или все свои 65535 разом? Хотя, наверное, без разницы - для одного клиента всё равно всё упрётся в 
клиентское ограничение исходящих портов.
Вообще, в целом, для уникальности соединения нужно уникальное сочетание пяти параметров: client ip, server ip, client port, server port, proto. 
Так что сервер с одним IPv6 адресом, внимательно слушающий какой-нибудь свой порт, по tcp...   3.4×10<sup>38</sup> адресов, помножить на 65536 соединений на клиента... 2.2282*10<sup>44</sup>, примерно так. 
Поменьше конечно немного, системные порты, зарезервированные диапазоны...  Опять же, системные лимиты - максимальное число открытых файлов, всякие там буферы TCP...

---
> 9. Может ли сложиться ситуация, при которой большое число соединений TCP на хосте находятся в состоянии  `TIME-WAIT`? Если да, то является ли она хорошей или плохой? Подкрепите свой ответ пояснением той или иной оценки.

`TIME-WAIT` - это финальное состояние TCP-соединения на стороне, которая инициировала закрытие этого соединения. Таким образом, упомянутая ситуация может сложиться, 
если хост слишком часто инициирует закрытие TCP-соединений, чаще, чем соединения с этим статусом освобождаются по таймауту (4 минуты). Соединения, висящие в состоянии TIME-WAIT, 
продолжают быть открытым сокетом и потреблять ресурсы, и занимать пару ip-port, что потенциально чревато их нехваткой. Так что, ситуация скорее плохая.     
Что можно сделать? Желательно понять, почему они возникают в большом количестве. Может, нас атакуют и перебирают пароли. Может, у нас поселился вирус и рассылает спам по миру. 
Может, у нас кривая информационная система и нужно использовать Keep-Alive. 
Если ситуация легитимная, и у нас просто очень большая нагрузка, можно попытаться балансить сервис на нескольких IP, или, включив через `sysctl` параметр net.ipv4.tcp_tw_reuse, разрешить 
использование занятых TIME-WAIT портов для исходящих соединений. Есть ещё много рецептов, но там ещё больше думать_надо. 

---
> 10. Чем особенно плоха фрагментация UDP относительно фрагментации TCP?

В UDP никаких встроенных механизмов фрагментации не предусмотрено. Поэтому, если у приложения данные не влезают в одну датаграмму, оно само должно реализовать алгоритмы 
фрагментации/сборки/реордеринга/контроля и всего прочего, чем славен TCP.

> 11. Если бы вы строили систему удаленного сбора логов, то есть систему, в которой несколько хостов отправяют на центральный узел генерируемые приложениями логи (предположим, что логи – текстовая информация), 
   какой протокол транспортного уровня вы выбрали бы и почему?
   
Конечно же UDP!
Размер текстовой строчки для лога обычно не так велик, и прекрасно влезет в UDP-датаграмму. Отсылка сообщения займёт минимум усилий и  ресурсов, можно не отслеживать, действительно ли она там принялась. 
Небольшая потеря сообщений для логов обычно не является серьёзной проблемой. Если генерится большое количество логов, то в случае сетевых проблем с TCP очередь отправки сообщений может вырасти очень 
быстро до огромных значений, это уже будет серъёзной проблемой. 

Собственно, случай из жизни: кассовый модуль одного системного интегратора в области розничной торговли использовал TCP для отправки текстовых логов на видеосервер, для наложения "текста чека" на 
видеоизображение. При необходимости перезагрузить видеосервер (от известного производителя), что с ним случалось довольно часто, все кассы просто висли, и размораживались только когда видеосервер 
снова заработает. 
К счастью, удалось упросить интегратора добавить для кассы поддержку UDP, и написать своё видеонаблюдение, с блекджеком и прочими необходимыми аттрибутами, 
которое умело принимать текст чека по UDP. Это решило все проблемы.

> Проверьте ваше предположение самостоятельно, узнав о стандартном протоколе syslog.
```
$ grep syslog /etc/services
syslog		514/udp
```
Ну надо же!!!

---
> 12. Сколько портов TCP находится в состоянии прослушивания на вашей виртуальной машине с Ubuntu, и каким процессам они принадлежат?
```
# ss -Htnlp 
LISTEN  0        4096             0.0.0.0:111     0.0.0.0:*   users:(("rpcbind",pid=596,fd=4),("systemd",pid=1,fd=35))  
LISTEN  0        4096       127.0.0.53%lo:53      0.0.0.0:*   users:(("systemd-resolve",pid=597,fd=13))                 
LISTEN  0        128              0.0.0.0:22      0.0.0.0:*   users:(("sshd",pid=798,fd=3))                             
LISTEN  0        4096                [::]:111        [::]:*   users:(("rpcbind",pid=596,fd=6),("systemd",pid=1,fd=37))  
LISTEN  0        128                 [::]:22         [::]:*   users:(("sshd",pid=798,fd=4))       
```

---
> 13. Какой ключ нужно добавить в `tcpdump`, чтобы он начал выводить не только заголовки, но и содержимое фреймов в текстовом виде? 

У tcpdump есть ключ `-A` для вывода фреймов в текстовом виде, но без ethernet-заголовков. Можно ещё указать `-e`, тогда будет выводиться и информация о заголовках - MAC адреса, VLAN...

> А в текстовом и шестнадцатиричном?

Тогда `-XX`, возможно, опять-таки в сочетании с `-e`

---
> 14. Попробуйте собрать дамп трафика с помощью `tcpdump` на основном интерфейсе вашей виртуальной машины и посмотреть его через tshark или Wireshark (можно ограничить число пакетов `-c 100`).

На виртуалке так и не дождался, нет там живого трафика. Собрал со своего хоста.

> Встретились ли вам какие-то установленные флаги Internet Protocol (не флаги TCP, а флаги IP)? Узнайте, какие флаги бывают.

С фильтром `ip.flags > 0` встретилось некоторое количество `Don't fragment`, флага `More Fragments` я не встретил.

> Как на самом деле называется стандарт Ethernet, фреймы которого попали в ваш дамп? 

Наверное, имеется ввиду `Ethernet II`, aka `DIX Ethernet`.

> Можно ли где-то в дампе увидеть OUI?

Да, в MAC-адресах встречаются. Но только Cisco. Логично, она мой рутер!